#!/usr/bin/env -S guile -s
!#

(use-modules (ice-9 ftw)
             (ice-9 match)
             (srfi srfi-13))

(define (project-root)
  (let* ((script-path (canonicalize-path (car (command-line))))
         (script-dir (dirname script-path)))
    (dirname script-dir)))

(add-to-load-path (string-append (project-root) "/src"))
(use-modules (handoff))

(define (usage)
  (display "Group Scholar Handoff Dossier\n\n")
  (display "Usage:\n")
  (display "  gs-handoff.scm init-db\n")
  (display "  gs-handoff.scm seed\n")
  (display "  gs-handoff.scm add --scholar NAME --cohort COHORT --priority LEVEL --summary TEXT --owner NAME --due YYYY-MM-DD [--status STATUS]\n")
  (display "  gs-handoff.scm list [--status STATUS] [--limit N]\n")
  (display "  gs-handoff.scm show ID\n")
  (display "  gs-handoff.scm close ID\n")
  (display "  gs-handoff.scm stats\n"))

(define (parse-flags args)
  (let loop ((rest args) (opts '()))
    (match rest
      (() (reverse opts))
      ((key value . tail)
       (if (string-prefix? "--" key)
           (loop tail (cons (cons (string->symbol (substring key 2)) value) opts))
           (error "Unexpected argument" key)))
      (_ (error "Invalid arguments" rest)))))

(define (require-key opts key)
  (let ((value (assoc-ref opts key)))
    (if value value (error (string-append "Missing required flag: --" (symbol->string key))))))

(define (print-list rows)
  (for-each
   (lambda (row)
     (display (assoc-ref row 'id)) (display " | ")
     (display (assoc-ref row 'scholar_name)) (display " | ")
     (display (assoc-ref row 'cohort)) (display " | ")
     (display (assoc-ref row 'priority)) (display " | ")
     (display (assoc-ref row 'status)) (display " | ")
     (display (assoc-ref row 'owner)) (display " | ")
     (display (assoc-ref row 'due_date)) (display " | ")
     (display (assoc-ref row 'created_at))
     (newline))
   rows))

(define (print-detail rows)
  (if (null? rows)
      (begin (display "No match.\n") (exit 0))
      (let ((row (car rows)))
        (for-each
         (lambda (field)
           (display (symbol->string field)) (display ": ")
           (display (or (assoc-ref row field) ""))
           (newline))
         '(id scholar_name cohort priority summary status owner due_date tags created_at updated_at)))))

(define (print-stats rows)
  (for-each
   (lambda (row)
     (display (assoc-ref row 'status)) (display ": ")
     (display (assoc-ref row 'count))
     (newline))
   rows))

(define (main)
  (match (cdr (command-line))
    (("init-db")
     (init-db)
     (display "Schema ready.\n"))
    (("seed")
     (seed-db)
     (display "Seed data loaded.\n"))
    (("add" . flags)
     (let* ((opts (parse-flags flags))
            (data `((scholar_name . ,(require-key opts 'scholar))
                    (cohort . ,(require-key opts 'cohort))
                    (priority . ,(require-key opts 'priority))
                    (summary . ,(require-key opts 'summary))
                    (owner . ,(require-key opts 'owner))
                    (due_date . ,(require-key opts 'due))
                    (status . ,(assoc-ref opts 'status))))
            (result (add-note data)))
       (display "Added note with id ")
       (display (car result))
       (newline)))
    (("list" . flags)
     (let* ((opts (parse-flags flags))
            (filters `((status . ,(assoc-ref opts 'status))
                       (limit . ,(assoc-ref opts 'limit)))))
       (print-list (list-notes filters))))
    (("show" id)
     (print-detail (show-note id)))
    (("close" id)
     (close-note id)
     (display "Closed note ")
     (display id)
     (newline))
    (("stats")
     (print-stats (stats)))
    (_
     (usage)
     (exit 1))))

(main)
